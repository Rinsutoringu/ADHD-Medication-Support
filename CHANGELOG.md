# 更新日志 - 导航和局域网联机功能

## 🎉 新增功能

### 1. ✅ 完整的导航系统
- **顶部导航栏**：所有页面都有导航栏
- **设置按钮**：右上角设置图标，可随时进入设置页面
- **返回按钮**：自动显示，可从任何二级页面返回主页

### 2. 🌐 局域网联机功能
基于 HTTP 服务器的真实局域网联机，无需 Firebase！

#### 服务器模式
- 启动本地 HTTP 服务器
- 自动获取本机局域网 IP
- 可自定义端口（默认 8080）
- 其他设备可连接查看你的用药数据

#### 客户端模式
- 连接到其他设备的服务器
- 输入对方 IP 和端口即可连接
- 实时同步对方的用药状态

#### 工作原理
```
设备A（服务器）         设备B（客户端）
    |                        |
    |-- 启动服务器           |
    |   192.168.1.100:8080  |
    |                        |
    |                        |-- 连接到 192.168.1.100:8080
    |                        |
    |<----- 请求数据 --------|
    |                        |
    |------ 返回数据 ------->|
    |                        |
    |<----- 推送更新 --------|
```

### 3. 👤 用户名设置
- 设置个性化用户名
- 用户名会显示给其他联机用户
- 使用 SharedPreferences 本地保存

## 📱 使用指南

### 导航使用
1. **主页**：启动后的默认页面
2. **设置页**：点击右上角设置图标进入
3. **返回主页**：点击左上角返回按钮或系统返回键

### 局域网联机设置

#### 作为服务器（让别人连接你）
1. 打开设置页面
2. 在"局域网联机"卡片中：
   - 查看你的本机 IP（自动获取）
   - 设置端口（默认 8080）
   - 点击"启动服务器"
3. 将你的 IP 和端口告诉其他用户
4. 开始用药后，其他用户可以看到你的状态

#### 作为客户端（连接别人）
1. 获取对方的 IP 和端口
2. 打开设置页面
3. 在"连接到其他设备"区域：
   - 输入对方的 IP 地址（如 192.168.1.100）
   - 确认端口号
   - 点击"连接"
4. 连接成功后可以看到对方的用药状态

### 用户名设置
1. 打开设置页面
2. 在"用户设置"卡片中：
   - 查看当前用户名
   - 输入新用户名
   - 点击"保存用户名"
3. 用户名会在联机时显示给其他用户

## 🔧 技术实现

### 网络服务（NetworkService）
```dart
// 启动服务器
await NetworkService().startServer(port: 8080);

// 获取本机 IP
final ip = await NetworkService().getLocalIp();

// 连接到其他设备
await NetworkService().connectToServer('192.168.1.100', 8080);

// 推送数据
await NetworkService().pushData(serverIp, serverPort, doseRecord);
```

### API 接口

#### GET /users
获取所有在线用户数据
```json
{
  "users": [
    {
      "id": "xxx",
      "userId": "user_123",
      "medication": {...},
      "doseTime": "2025-11-21T15:30:00.000Z"
    }
  ]
}
```

#### POST /update
更新用户数据
```json
{
  "id": "xxx",
  "userId": "user_123",
  "medication": {...},
  "doseTime": "2025-11-21T15:30:00.000Z"
}
```

## 📂 新增文件

```
lib/
├── services/
│   └── network_service.dart      # 局域网联机服务
├── pages/
│   └── settings_page.dart        # 设置页面
```

## 🔐 安全说明

### 局域网限制
- 只能在同一局域网内使用
- 不会暴露到公网
- 建议只在可信网络中使用

### 防火墙设置
某些防火墙可能会阻止连接，需要：
- Windows: 允许应用通过防火墙
- Android: 授予网络权限（已自动配置）
- iOS: 允许本地网络访问

### 数据隐私
- 数据仅在局域网内传输
- 不会上传到任何云服务
- 其他用户只能看到你公开的用药状态

## ⚙️ 常见问题

### Q: 无法连接到其他设备？
A: 检查：
1. 是否在同一 Wi-Fi 网络
2. IP 地址是否正确
3. 端口是否被占用
4. 防火墙是否允许

### Q: 找不到本机 IP？
A: 
1. 确保已连接到 Wi-Fi
2. 重启应用
3. 手动在系统设置中查看 IP

### Q: 服务器启动失败？
A:
1. 端口可能被占用，尝试其他端口
2. 检查防火墙设置
3. 重启应用

### Q: 对方看不到我的状态？
A:
1. 确保已启动服务器
2. 确保已开始用药监测
3. 让对方重新连接

## 🎯 使用场景

### 场景 1: 家庭使用
- 父母启动服务器
- 孩子连接查看父母的用药提醒
- 互相监督用药时间

### 场景 2: 学习小组
- 小组成员互相连接
- 查看彼此的专注时段
- 协调学习时间

### 场景 3: 医疗监护
- 医护人员启动服务器
- 患者连接查看建议
- 实时监测用药状况

## 🚀 下一步计划

- [ ] 添加消息推送功能
- [ ] 支持语音通话提醒
- [ ] 添加用药提醒分享
- [ ] 支持多人群组
- [ ] 添加加密传输
- [ ] 支持蓝牙近场连接

## 📞 技术支持

如遇问题：
1. 查看本文档的"常见问题"部分
2. 检查系统网络设置
3. 查看应用控制台日志

---

**现在你可以和朋友一起追踪药效了！** 🎉✨
